@using EuroConnector.ClientApp.Data.Interfaces

@inject AuthenticationProvider AuthProvider
@inject ISetupService SetupService

<Error>
	<Router AppAssembly="@typeof(Main).Assembly">
		<Found Context="routeData">
			<AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)">
				<NotAuthorized>
					<RedirectToLogin />
				</NotAuthorized>
			</AuthorizeRouteView>
			<FocusOnNavigate RouteData="@routeData" Selector="h1" />
		</Found>
		<NotFound>
			<LayoutView Layout="@typeof(MainLayout)">
				<p role="alert">Sorry, there's nothing at this address.</p>
			</LayoutView>
		</NotFound>
	</Router>
</Error>

@code
{
	protected override void OnInitialized()
	{
		var refreshToken = Preferences.Get("refreshToken", string.Empty);
		var refreshExpiration = Preferences.Get("refreshExpiration", new DateTime());
		if (!string.IsNullOrEmpty(refreshToken) && DateTime.UtcNow > refreshExpiration.ToUniversalTime())
		{
			AuthProvider.SignOut();
			SetupService.ClearSettings(new[] { "accessToken", "accessExpiration", "refreshToken", "refreshExpiration", "apiUrl" });
		}

		var accessToken = Preferences.Get("accessToken", string.Empty);
		if (!string.IsNullOrEmpty(accessToken)) AuthProvider.SignIn(accessToken);
	}
}
