@using Blazored.LocalStorage;

@inject ILocalStorageService LocalStorage
@inject AuthenticationProvider AuthProvider

<Error>
	<Router AppAssembly="@typeof(Main).Assembly">
		<Found Context="routeData">
			<AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)">
				<NotAuthorized>
					<RedirectToLogin />
				</NotAuthorized>
			</AuthorizeRouteView>
			<FocusOnNavigate RouteData="@routeData" Selector="h1" />
		</Found>
		<NotFound>
			<LayoutView Layout="@typeof(MainLayout)">
				<p role="alert">Sorry, there's nothing at this address.</p>
			</LayoutView>
		</NotFound>
	</Router>
</Error>

@code
{
	protected override async Task OnInitializedAsync()
	{
		var refreshToken = await LocalStorage.GetItemAsync<string>("refreshToken");
		var refreshExpiration = await LocalStorage.GetItemAsync<DateTime>("refreshExpiration");
		if (!string.IsNullOrEmpty(refreshToken) && DateTime.UtcNow > refreshExpiration.ToUniversalTime())
		{
			AuthProvider.SignOut();
			await LocalStorage.RemoveItemsAsync(new List<string> { "accessToken", "accessExpiration", "refreshToken", "refreshExpiration", "apiUrl" });
		}

		var accessToken = await LocalStorage.GetItemAsync<string>("accessToken");
		if (!string.IsNullOrEmpty(accessToken)) AuthProvider.SignIn(accessToken);
	}
}
